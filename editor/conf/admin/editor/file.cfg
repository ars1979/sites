# filename: conf/admin/editor/file/editor.cfg
# path: /admin/editor/file/editor

## DO NOT EDIT THIS FILE WITH EDITOR ITSELF


############################################################
##
## Admin : Editor : File Manager
##
############################################################

# Includes

# Html elements
include conf/elements/html-basic.cfg
include conf/elements/html-bootstrap-panel.cfg
include conf/elements/html-datatables.cfg

# Database settings
include conf/settings/db.cfg

# Theme picker
include conf/admin/editor/elements/themepicker.cfg


# Vars

# Page name
view_name: &view_name "Admin : Editor : File Editor"

ace: &ace
	height: 78%
	width: 100%
	theme: iplastic
	path: '{{filepath}}'
	value: |
		<div style="margin-bottom: 10px;">
			<div id="editor-{{id}}" style="width: {{width}}; height: {{height}};"></div>
		</div>
		<script>
			$(document).ready( function() {
				
				var mode = 'text'
				var filename = '{{cache:editor_path}}'
				
				var ext = filename.substr(filename.lastIndexOf('.') + 1);
				
				switch (ext) {
				    case "cfg":
					mode = 'yaml'
					break;
				    case "sql":
					mode = "mysql";
					break;
				    case "html":
					mode = "html";
					break;
				    case "js":
					mode = "javascript";
					break;
				    case "css":
					mode = "css";
					break;
				    case "py":
					mode = "python";
					break;					
				}
				
				var code = ''
				$.get('/admin/editor/loader?path='+filename, function(data) {
					code = data.replace(/    /g, '\t');
					
					var editor = ace.edit("editor-{{id}}");
					editor.getSession().setMode("ace/mode/"+mode);
					editor.setTheme("ace/theme/{{session:theme}}");
					editor.setOptions({ tabSize: 4, useSoftTabs: false, fontSize: "11pt" });
					//editor.setReadOnly(true);
					editor.setShowPrintMargin(false);
					editor.setHighlightActiveLine(false);
					//editor.setHighlightGutterLine(false);
					//editor.renderer.setShowGutter(false)				
					editor.insert(code);
					editor.scrollToLine(1, true, true, function () {});
					editor.gotoLine(1, 0, true);
					editor.getSession().on('change', function() {
						//$('#code').val(editor.getValue())
						$('#code_save_as').val(editor.getValue())
					});
					//$('#code').val(editor.getValue())
					$('#code_save_as').val(editor.getValue())
					
				});
				
			})
		</script>


# View
view: &view
	content:
		process:
			-
				# Was a get:path given?
				**if
				expression: '{{exists(get:path)}}'
				true:
					**cacheCache
					cache:
						editor_path: '{{get:path}}'
			-
				# Was a post:path given
				**if
				expression: '{{exists(post:path_save)}}'
				true:
					**cacheCache
					cache:
						editor_path: '{{post:path_save}}'
			-
				# Was a post:path given
				**if
				expression: '{{exists(post:path_save_as)}}'
				true:
					**cacheCache
					cache:
						editor_path: '{{post:path_save_as}}'						
			-
				**if
				expression: '{{exists(cache:editor_path)}}'
				true:
					content:
						-
							**div
							content:
								-
									**div9
									#class: form-inline
									content:
										-
											**form
											name: save_as_code
											class: form-inline
											content:
												# SAVE Button
												-
													**hidden
													name: code_save_as
												-
													**textbox
													#width: 9
													name: path_save_as
													value: '{{cache:editor_path}}'
													wrap: |
														<div class="form-group row {{error_class}}" style="{{style}}">
															<label for="{{field:id}}" class="control-label">{{required_indicator}}{{label}}</label>
															|
														</div>
													style: 'width: 200px;'
												-
													**button
													name: save_as
													attributes:
														html: '<i class="fa fa-floppy-o"></i> Save'
													class: btn btn-success
													wrap: |
														<div class="form-group" style="{{style}}">
															|
														</div>
													value: 1
													
										#-
										#	**form
										#	name: delete_form
										#	class: form-inline
										#	content:
												-
													value: |
														<!-- Button trigger modal -->
														<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#myModal">
														  <i class="fa fa-trash-o"></i> Delete
														</button>
													wrap: |
														<div class="form-group" style="{{style}}">
															|
														</div>
													
												-
													value: |
														<a class="btn btn-default" onclick="window.top.close();">close</a>
														
											postprocess:
												-
													**if
													expression: '{{exists(post:save_as)}}'
													true:													
														**fileWrite
														path: '{{cache:editor_path}}'
														value: '{{strip(post:code_save_as)}}'
														nobackup:

								# PICKER
								-
									**div3
									#style: 'height: 50px;'
									content:
										- 
											**themepicker
											class: pull-right form-inline
									#class: pull-right
						
						# Modal
						-
							wrap: |
								<!-- Modal -->
								<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
								  <div class="modal-dialog" role="document">
								    <div class="modal-content">
								      <div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
									<h4 class="modal-title" id="myModalLabel">Modal title</h4>
								      </div>
								      <div class="modal-body">
									Are you sure you want to delete this file?
								      </div>
								      <div class="modal-footer">
									|
								      </div>
								    </div>
								  </div>
								</div>
							content:
								**form
								name: delete_form
								class: form-inline
								content:
									-
										value: |
											<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
									-
										**button
										name: delete
										attributes:
											html: '<i class="fa fa-trash-o"></i> Delete'
										class: btn btn-danger
										value: 1	
										wrap: |
											<div class="form-group" style="{{style}}">
												|
											</div>										

								postprocess:
									-
										**if
										expression: '{{exists(post:delete)}}'
										true:													
											**fileDelete
											path: '{{cache:editor_path}}'
											nobackup:
											true:
												content:
													value: |
														<script>
															$(document).ready( function() {
																window.top.close();
															})
														</script>
									
									
						# ACE
						-
							**js
							value: '/static/bower_components/ace/src-noconflict/ace.js'

						-
							**ace
							id: reader
						-
							value: |
								<script>
									$(document).keydown(function(event) {
										// If Control or Command key is pressed and the S key is pressed
										// run save function. 83 is the key code for S.
										if((event.ctrlKey || event.metaKey) && event.which == 83) {
										    
										    // Save Function
										    $('#save_as').trigger('click');
										    
										    // prevent default
										    event.preventDefault();
										    return false;										    
										    
										}
										
										if((event.ctrlKey || event.metaKey) && event.which == 87) {
										    
										    // Close Function
										    window.top.close();
										    
										    // prevent default
										    event.preventDefault();
										    return false;										    
										    
										}										
										
									    }
									);							
								</script>
				
			
include conf/admin/template_private.cfg